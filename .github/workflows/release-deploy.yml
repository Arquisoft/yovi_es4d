name: Release — Build & Deploy

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

env:
  IMAGE_TAG: ${{ github.event.release.tag_name }}

jobs:
  docker-push-users:
    name: Publish users image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to Registry (users)
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: ${{ github.repository_owner }}/${{ github.event.repository.name }}-users
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          workdir: users

  docker-push-webapp:
    name: Publish webapp image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to Registry (webapp)
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: ${{ github.repository_owner }}/${{ github.event.repository.name }}-webapp
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          workdir: webapp
          buildargs: VITE_API_URL=http://${{ secrets.DEPLOY_HOST }}:3000

  docker-push-gamey:
    name: Publish gamey image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to Registry (gamey)
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: ${{ github.repository_owner }}/${{ github.event.repository.name }}-gamey
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          workdir: gamey

  deploy:
    name: Deploy over SSH
    runs-on: ubuntu-latest
    name: Release — Build & Deploy

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

env:
  IMAGE_TAG: ${{ github.event.release.tag_name }}

jobs:
  docker-push-users:
    name: Publish users image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to Registry (users)
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: ${{ github.repository_owner }}/${{ github.event.repository.name }}-users
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          workdir: users

  docker-push-webapp:
    name: Publish webapp image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to Registry (webapp)
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: ${{ github.repository_owner }}/${{ github.event.repository.name }}-webapp
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          workdir: webapp
          buildargs: VITE_API_URL=http://${{ secrets.DEPLOY_HOST }}:3000

  docker-push-gamey:
    name: Publish gamey image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish to Registry (gamey)
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          name: ${{ github.repository_owner }}/${{ github.event.repository.name }}-gamey
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          workdir: gamey

  deploy:
    name: Deploy over SSH
    runs-on: ubuntu-latest
    needs: [docker-push-users, docker-push-webapp, docker-push-gamey, docker-push-game, docker-push-gateway]
    steps:
      - name: Deploy over SSH
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          user: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command: |
            wget https://raw.githubusercontent.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/${{ github.event.release.tag_name }}/docker-compose.yml -O docker-compose.yml            docker compose down
            docker compose up -d --pull always
    steps:
      - name: Deploy over SSH
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          user: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command: |
            wget https://raw.githubusercontent.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/${{ github.event.release.tag_name }}/docker-compose.yml -O docker-compose.yml            docker compose down
            docker compose up -d --pull always
